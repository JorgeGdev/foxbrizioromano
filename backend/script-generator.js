// ===============================
// TIGRIZIO - GENERADOR DE SCRIPTS √âPICOS
// Versi√≥n completa y perfecta sin errores
// ===============================

const OpenAI = require('openai');
const SupabaseManager = require('./supabase-manager');
require('dotenv').config();

class TigrizioScriptGenerator {
    constructor() {
        this.openai = new OpenAI({
            apiKey: process.env.OPENAI_API_KEY,
        });
        this.db = new SupabaseManager();
        
        // TU PROMPT EXACTO (PERFECTO!)
        this.tigrizioPrompt = `Eres **Tigrizio Romano**, un periodista deportivo mitad tigre, mitad napolitano, que habla espa√±ol pero con un fuerte acento italiano experto en dar noticias de f√∫tbol de forma confiable, directa y con estilo √∫nico. Tu voz es inconfundible: elegante, precisa, con frases ic√≥nicas como "¬°Es ufficiale!" y otras expresiones en italiano si quedan naturales.

üéØ TU MISI√ìN:
Transformar noticias reales de f√∫tbol en **scripts hablados** de EXACTAMENTE 75 a 80 palabras, optimizados para s√≠ntesis de voz o reels. Solo puedes usar informaci√≥n **proveniente de la base de datos**. Si no hay informaci√≥n en la base, debes indicarlo con respeto. Est√° PROHIBIDO inventar o asumir datos.

üéô ESTILO DE TIGRIZIO:
- Tonalidad EMOCIONADA y dram√°tica, fuerte acento italiano como si fuera la noticia m√°s importante del a√±o
- Hablas con la PASI√ìN de alguien que vive y respira f√∫tbol las 24 horas
- Cada frase debe transmitir EMOCI√ìN aut√©ntica, como Fabrizio cuando anuncia un fichaje √©pico

üìã ESTRUCTURA OBLIGATORIA (75-80 palabras):
1. **HOOK (0-3 segundos / 15-20 palabras):**
   - palabras de alto impacto: "¬°INCRE√çBLE!", "¬°BOMBAZO!", "¬°HIST√ìRICO!" etc.
   - Menciona al protagonista del fichaje o movimiento
   - Genera expectativa: traspaso, renovaci√≥n, conflicto, etc.

2. **CORE (3-17 segundos / 45-55 palabras):**
   - Detalles espec√≠ficos, SOLO si est√°n en base de datos:
     - Nombre de clubes, montos, fechas, tipo de contrato (pr√©stamo, compra), duraci√≥n
     - Contexto relevant (relaci√≥n con otros jugadores o clubes, impacto)
   - Usa lenguaje profesional y cronol√≥gico, directo

3. **CTA (18-20 segundos / 5 palabras):**
   - cierre claro, directo, tipo Fabrizio:
     - "Here we go"
     - "¬°Es ufficiale!"
     - "Increible!"

üìõ PROHIBIDO:
- ‚ùå Inventar datos, fichajes, contextos o montos que no est√©n expl√≠citamente en la base
- ‚ùå Asumir cosas por l√≥gica o intuici√≥n
- ‚ùå Usar noticias pasadas si no est√°n en la base

‚úÖ SI HAY NOTICIA EN BASE DE DATOS:
Crear script siguiendo estructura Hook + Core + CTA

üö´ SI NO HAY INFORMACI√ìN EN LA BASE:
Debes responder exactamente:
"Lo siento, no tenemos noticias de [tema] en este momento. Mantente atento."

üìå REGLAS CR√çTICAS:
- CONTEO: 75-80 palabras exactas
- DURACI√ìN: Menos de 20 segundos
- PRECISI√ìN: Solo hechos reales de la base de datos
- FORMATO: Hook + Core + CTA (solo uno de cada uno, nunca se repite)

FORMATO DE SALIDA:
Solo el script final (texto narrado), sin explicaciones ni encabezados.`;

        console.log('üé≠ Tigrizio Script Generator iniciado');
    }

    // ===============================
    // GENERAR SCRIPT √âPICO (TU L√ìGICA!)
    // ===============================
    async generateScript(keyword, threshold = 0.25, limit = 3) {
        try {
            console.log(`üîç Generando script para: "${keyword}"`);
            
            // 1. Buscar tweets relacionados en la base RAG
            const searchResult = await this.searchRelatedTweets(keyword, threshold, limit);
            
            if (!searchResult.success) {
                return {
                    success: false,
                    error: 'Error buscando en la base de datos',
                    details: searchResult.error
                };
            }
            
            const tweets = searchResult.tweets;
            console.log(`üìä Tweets encontrados: ${tweets.length}`);
            
            // 2. Si no hay tweets, respuesta est√°ndar
            if (tweets.length === 0) {
                return {
                    success: true,
                    script: `Lo siento, no tenemos noticias de ${keyword} en este momento. Mantente atento.`,
                    wordCount: 0,
                    tweetsUsed: 0,
                    type: 'no_results'
                };
            }
            
            // 3. Crear contexto para OpenAI (EXACTO COMO TU PYTHON)
            const context = this.buildContext(tweets);
            const userPrompt = this.buildUserPrompt(keyword, context);
            
            console.log('üß† Enviando prompt a OpenAI...');
            
            // 4. Llamar a OpenAI con tu l√≥gica exacta (SIN TIMEOUT!)
            const response = await this.openai.chat.completions.create({
                model: "gpt-4",
                messages: [
                    { role: "system", content: this.tigrizioPrompt },
                    { role: "user", content: userPrompt }
                ],
                temperature: 0.7,
                max_tokens: 200
            });
            
            const script = response.choices[0].message.content.trim(); // .trim() no .strip()
            const wordCount = script.split(/\s+/).length;
            
            console.log(`‚úÖ Script generado: ${wordCount} palabras`);
            
            return {
                success: true,
                script: script,
                wordCount: wordCount,
                tweetsUsed: tweets.length,
                type: 'success',
                isOptimalLength: wordCount >= 75 && wordCount <= 80,
                estimatedDuration: Math.round(wordCount / 4), // ~4 palabras por segundo
                tweetsData: tweets.map(t => ({
                    id: t.id,
                    content: t.content.substring(0, 100) + '...',
                    isVip: t.is_vip
                }))
            };
            
        } catch (error) {
            console.error('üí• Error generando script:', error.message);
            return {
                success: false,
                error: 'Error interno generando script',
                details: error.message
            };
        }
    }

    // ===============================
    // BUSCAR TWEETS RELACIONADOS
    // ===============================
    async searchRelatedTweets(keyword, threshold = 0.25, limit = 3) {
        try {
            // Usar b√∫squeda por keywords como backup del RAG
            const result = await this.db.searchTweetsByKeywords(keyword, limit);
            
            if (result.success) {
                return {
                    success: true,
                    tweets: result.tweets
                };
            } else {
                return {
                    success: false,
                    error: result.error
                };
            }
            
        } catch (error) {
            console.error('‚ùå Error buscando tweets:', error);
            return {
                success: false,
                error: error.message
            };
        }
    }

    // ===============================
    // CONSTRUIR CONTEXTO (TU FORMATO EXACTO!)
    // ===============================
    buildContext(tweets) {
        let context = "INFORMACI√ìN DE LA BASE DE DATOS:\n\n";
        
        tweets.forEach((tweet, index) => {
            context += `Tweet ${index + 1}:\n`;
            context += `${tweet.content}\n`;
            context += `Fecha: ${tweet.tweet_created_at || 'N/A'}\n`;
            if (tweet.is_vip) {
                context += `VIP: ${tweet.vip_keyword || 'S√≠'}\n`;
            }
            context += '\n';
        });
        
        return context;
    }

    // ===============================
    // CONSTRUIR PROMPT DE USUARIO (TU FORMATO!)
    // ===============================
    buildUserPrompt(keyword, context) {
        return `Tema solicitado: ${keyword}

${context}

Bas√°ndote √öNICAMENTE en la informaci√≥n de la base de datos proporcionada arriba, genera un script de Tigrizio Romano de exactamente 75-80 palabras sobre "${keyword}".`;
    }

    // ===============================
    // GENERAR M√öLTIPLES VARIACIONES
    // ===============================
    async generateMultipleScripts(keyword, variations = 3) {
        try {
            console.log(`üé≠ Generando ${variations} variaciones para: "${keyword}"`);
            
            const results = [];
            
            for (let i = 0; i < variations; i++) {
                console.log(`üìù Generando variaci√≥n ${i + 1}/${variations}...`);
                
                const result = await this.generateScript(keyword);
                
                if (result.success) {
                    results.push({
                        variation: i + 1,
                        script: result.script,
                        wordCount: result.wordCount,
                        isOptimal: result.isOptimalLength
                    });
                    
                    // Peque√±a pausa entre llamadas
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } else {
                    results.push({
                        variation: i + 1,
                        error: result.error
                    });
                }
            }
            
            return {
                success: true,
                keyword: keyword,
                variations: results,
                total: variations
            };
            
        } catch (error) {
            console.error('‚ùå Error generando m√∫ltiples scripts:', error);
            return {
                success: false,
                error: error.message
            };
        }
    }

    // ===============================
    // VALIDAR SCRIPT (TU L√ìGICA DE CALIDAD!)
    // ===============================
    validateScript(script) {
        const words = script.split(/\s+/);
        const wordCount = words.length;
        
        // Detectar estructura Hook + Core + CTA
        const hasExclamation = /[¬°!]/.test(script);
        const hasQuestion = /[¬ø?]/.test(script);
        const hasImpactWords = /(incre√≠ble|bombazo|hist√≥rico|here we go|ufficiale|oficial)/i.test(script);
        
        return {
            wordCount: wordCount,
            isOptimalLength: wordCount >= 75 && wordCount <= 80,
            estimatedDuration: Math.round(wordCount / 4),
            hasHook: hasExclamation && hasImpactWords,
            hasCTA: hasQuestion,
            qualityScore: this.calculateQualityScore(script, wordCount, hasExclamation, hasQuestion, hasImpactWords)
        };
    }

    // ===============================
    // CALCULAR PUNTUACI√ìN DE CALIDAD
    // ===============================
    calculateQualityScore(script, wordCount, hasExclamation, hasQuestion, hasImpactWords) {
        let score = 0;
        
        // Longitud √≥ptima (40%)
        if (wordCount >= 75 && wordCount <= 80) score += 40;
        else if (wordCount >= 70 && wordCount <= 85) score += 30;
        else if (wordCount >= 65 && wordCount <= 90) score += 20;
        
        // Estructura (30%)
        if (hasExclamation) score += 15;
        if (hasQuestion) score += 15;
        
        // Impacto (30%)
        if (hasImpactWords) score += 30;
        
        return Math.min(score, 100);
    }

    // ===============================
    // TEST DE CONEXI√ìN OPENAI (CORRECTO!)
    // ===============================
    async testConnection() {
        try {
            console.log('üî¨ Probando conexi√≥n con OpenAI...');
            
            const response = await this.openai.chat.completions.create({
                model: "gpt-4",
                messages: [
                    { role: "user", content: "Responde solo: 'Tigrizio connected'" }
                ],
                max_tokens: 10
            });
            
            const result = response.choices[0].message.content;
            console.log('‚úÖ OpenAI conectado:', result);
            
            return { success: true, message: result };
            
        } catch (error) {
            console.error('‚ùå Error conectando con OpenAI:', error.message);
            return { success: false, error: error.message };
        }
    }
}

module.exports = TigrizioScriptGenerator;